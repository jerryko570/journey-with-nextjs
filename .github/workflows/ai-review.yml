name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- '*.js' '*.jsx' '*.ts' '*.tsx' '*.py' '*.java' '*.go' '*.css' '*.html')
          DIFF_LIMITED=$(echo "$DIFF" | head -c 15000)
          {
            echo "diff<<EOF"
            echo "$DIFF_LIMITED"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -q google-generativeai

      - name: Run AI Review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
        run: |
          python << 'EOF'
          import google.generativeai as genai
          import os
          import sys

          try:
              api_key = os.environ.get('GEMINI_API_KEY')
              if not api_key:
                  print("ERROR: GEMINI_API_KEY not found")
                  sys.exit(1)

              genai.configure(api_key=api_key)
              model = genai.GenerativeModel('gemini-1.5-flash')
              
              diff_text = os.environ.get('PR_DIFF', '').strip()
              
              if not diff_text:
                  result = "## ðŸ“ ë³€ê²½ì‚¬í•­ ì—†ìŒ\n\në¦¬ë·°í•  ì½”ë“œ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
              else:
                  prompt = f'''ë‹¹ì‹ ì€ ì‹œë‹ˆì–´ ì†Œí”„íŠ¸ì›¨ì–´ ì—”ì§€ë‹ˆì–´ìž…ë‹ˆë‹¤.
          ë‹¤ìŒ Pull Requestì˜ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”.

          ì½”ë“œ ë³€ê²½ì‚¬í•­:
          {diff_text}

          ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ í•œêµ­ì–´ë¡œ ìž‘ì„±í•´ì£¼ì„¸ìš”:

          ## ðŸ” ì£¼ìš” ë°œê²¬ì‚¬í•­
          - ë²„ê·¸ ê°€ëŠ¥ì„±
          - ë³´ì•ˆ ì·¨ì•½ì 
          - ì„±ëŠ¥ ì´ìŠˆ

          ## âœ… ìž˜ ìž‘ì„±ëœ ë¶€ë¶„
          - ì¢‹ì€ íŒ¨í„´ê³¼ ì½”ë“œ

          ## ðŸ’¡ ê°œì„  ì œì•ˆ
          - êµ¬ì²´ì ì¸ ì œì•ˆ

          ## ðŸ“Š ì¢…í•© í‰ê°€
          ì ìˆ˜ì™€ í•œ ì¤„ í‰ê°€

          ì¤‘ìš”í•œ ì´ìŠˆì—ë§Œ ì§‘ì¤‘í•´ì£¼ì„¸ìš”.'''

                  response = model.generate_content(
                      prompt,
                      generation_config={'temperature': 0.7, 'max_output_tokens': 2048}
                  )
                  result = response.text

              with open('review.txt', 'w', encoding='utf-8') as f:
                  f.write(result)
              
              print("Review generated successfully")

          except Exception as e:
              error = f'''## âš ï¸ ë¦¬ë·° ì‹¤íŒ¨

          ì˜¤ë¥˜: {str(e)}

          ê°€ëŠ¥í•œ ì›ì¸:
          - API í‚¤ ì˜¤ë¥˜
          - API í• ë‹¹ëŸ‰ ì´ˆê³¼
          - ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ'''
              
              with open('review.txt', 'w', encoding='utf-8') as f:
                  f.write(error)
              print(f"ERROR: {e}")
              sys.exit(1)
          EOF

      - name: Post Review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.txt', 'utf8');
            const pr = context.payload.pull_request;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `## ðŸ¤– AI ì½”ë“œ ë¦¬ë·°

${review}

---
ðŸ“Š **PR í†µê³„**
- ðŸ“ íŒŒì¼: ${pr.changed_files}ê°œ
- âž• ì¶”ê°€: ${pr.additions}ì¤„  
- âž– ì‚­ì œ: ${pr.deletions}ì¤„

*Powered by Google Gemini 1.5 Flash*`
            });