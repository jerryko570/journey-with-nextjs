name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          # base branch fetch
          git fetch origin ${{ github.base_ref }}
          
          # íŒŒì¼ í™•ì¥ìë³„ë¡œ diff ê°€ì ¸ì˜¤ê¸°
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- \
            '*.js' '*.jsx' '*.ts' '*.tsx' \
            '*.py' '*.java' '*.go' '*.rb' \
            '*.css' '*.scss' '*.html' '*.vue')
          
          # ë„ˆë¬´ ê¸¸ë©´ ì•ë¶€ë¶„ë§Œ (Gemini API ì œí•œ)
          DIFF_LIMITED=$(echo "$DIFF" | head -c 15000)
          
          # EOF êµ¬ë¶„ìë¡œ multiline ì €ì¥
          {
            echo "diff<<DIFF_EOF"
            echo "$DIFF_LIMITED"
            echo "DIFF_EOF"
          } >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: AI Review with Gemini
        id: review
        run: |
          pip install -q google-generativeai
          
          cat > review_script.py << 'PYTHON_SCRIPT'
          import google.generativeai as genai
          import os
          import sys
          
          try:
              genai.configure(api_key=os.environ['GEMINI_API_KEY'])
              model = genai.GenerativeModel('gemini-1.5-flash')
              
              diff_text = os.environ.get('PR_DIFF', '')
              
              if not diff_text or diff_text.strip() == '':
                  print("## ğŸ“ ë³€ê²½ì‚¬í•­ ì—†ìŒ\n\nì´ PRì—ëŠ” ë¦¬ë·°í•  ì½”ë“œ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.")
                  sys.exit(0)
              
              prompt = f"""ë‹¹ì‹ ì€ ì‹œë‹ˆì–´ ì†Œí”„íŠ¸ì›¨ì–´ ì—”ì§€ë‹ˆì–´ì…ë‹ˆë‹¤. ë‹¤ìŒ Pull Requestì˜ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”.

ì½”ë“œ ë³€ê²½ì‚¬í•­ (git diff):
```diff
{diff_text}
```

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ **í•œêµ­ì–´**ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”:

## ğŸ” ì£¼ìš” ë°œê²¬ì‚¬í•­
- ë²„ê·¸ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ì½”ë“œ
- ë³´ì•ˆ ì·¨ì•½ì 
- ì„±ëŠ¥ ì´ìŠˆ
- ë¡œì§ ì˜¤ë¥˜

(ì—†ìœ¼ë©´ "ë°œê²¬ëœ ì£¼ìš” ì´ìŠˆ ì—†ìŒ" ì¶œë ¥)

## âœ… ì˜ ì‘ì„±ëœ ë¶€ë¶„
- ì¢‹ì€ ì½”ë”© íŒ¨í„´
- ëª…í™•í•œ ë„¤ì´ë°
- ì ì ˆí•œ ì—ëŸ¬ ì²˜ë¦¬

## ğŸ’¡ ê°œì„  ì œì•ˆ
- êµ¬ì²´ì ì¸ ê°œì„  ë°©ë²•
- ê°€ëŠ¥í•˜ë©´ ì½”ë“œ ì˜ˆì‹œ í¬í•¨
- ë¦¬íŒ©í† ë§ ì•„ì´ë””ì–´

## ğŸ“Š ì¢…í•© í‰ê°€
ì ìˆ˜: â­â­â­â­â­ (5ì  ë§Œì )
í•œ ì¤„ ì½”ë©˜íŠ¸

**ì£¼ì˜ì‚¬í•­:**
- ì‚¬ì†Œí•œ ìŠ¤íƒ€ì¼ ì§€ì ì€ ìƒëµ
- ì¤‘ìš”í•œ ì´ìŠˆì— ì§‘ì¤‘
- ê±´ì„¤ì ì¸ í”¼ë“œë°± ì œê³µ
"""
              
              response = model.generate_content(
                  prompt,
                  generation_config={
                      'temperature': 0.7,
                      'top_p': 0.95,
                      'max_output_tokens': 2048,
                  }
              )
              
              review_text = response.text
              
              with open('review_output.txt', 'w', encoding='utf-8') as f:
                  f.write(review_text)
              
              print(review_text)
              
          except Exception as e:
              error_msg = f"""## âš ï¸ ë¦¬ë·° ìƒì„± ì‹¤íŒ¨
              
ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}

**ê°€ëŠ¥í•œ ì›ì¸:**
- API í‚¤ ì„¤ì • ì˜¤ë¥˜
- API í• ë‹¹ëŸ‰ ì´ˆê³¼
- ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ

GitHub Settingsì—ì„œ GEMINI_API_KEYë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."""
              
              with open('review_output.txt', 'w', encoding='utf-8') as f:
                  f.write(error_msg)
              
              print(error_msg)
              sys.exit(1)
          PYTHON_SCRIPT
          
          python review_script.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review_output.txt', 'utf8');
            
            const prNumber = context.payload.pull_request.number;
            const prInfo = context.payload.pull_request;
            
            const commentBody = `## ğŸ¤– AI ì½”ë“œ ë¦¬ë·° ì™„ë£Œ!

${review}

---
<details>
<summary>ğŸ“ˆ PR í†µê³„</summary>

- ğŸ“ ë³€ê²½ëœ íŒŒì¼: **${prInfo.changed_files}ê°œ**
- â• ì¶”ê°€ëœ ì¤„: **${prInfo.additions}ì¤„**
- â– ì‚­ì œëœ ì¤„: **${prInfo.deletions}ì¤„**
- ğŸ’¬ ì»¤ë°‹ ìˆ˜: **${prInfo.commits}ê°œ**

</details>

*ğŸ”® Powered by Google Gemini 1.5 Flash | â±ï¸ ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });

      - name: Review Summary
        if: always()
        run: |
          echo "âœ… AI ì½”ë“œ ë¦¬ë·°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "PR í˜ì´ì§€ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”."